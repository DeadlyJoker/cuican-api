# 支付方式配置指南

## 概述

本系统支持多种支付方式，包括：
- **支付宝** (Alipay)
- **微信支付** (WeChat Pay / WxPay)
- **Stripe** (国际信用卡支付)
- **Creem** (第三方支付网关)
- **其他易支付支持的支付方式**

## 支付宝和微信支付配置

### 前置条件

1. **易支付网关配置**（必需）：
   - 支付地址（PayAddress）：易支付网关的 API 地址，例如 `https://your-epay-domain.com`
   - 易支付商户ID（EpayId）：在易支付服务商处注册后获得的商户ID
   - 易支付商户密钥（EpayKey）：在易支付服务商处配置的商户密钥，用于签名验证

2. **易支付服务商通道开通**（必需）：
   - 确保您的易支付服务商已开通**支付宝支付通道**
   - 确保您的易支付服务商已开通**微信支付通道**
   - 如果未开通，请联系易支付服务商进行开通

3. **服务器配置**（推荐）：
   - 服务器地址（ServerAddress）：用于生成支付回调地址
   - 回调地址（CustomCallbackAddress）：可选，如果未配置则使用服务器地址
   - 回调地址格式：`{回调地址}/api/user/epay/notify`
   - **重要**：回调地址必须可公网访问，建议使用 HTTPS

### 配置步骤

#### 方法一：通过管理后台配置（推荐）

1. 登录管理后台
2. 进入 **设置** → **支付设置** → **支付网关设置**
3. 找到 **"充值方式设置"** (PayMethods) 字段
4. 输入以下 JSON 配置：

```json
[
  {
    "name": "支付宝",
    "type": "alipay",
    "color": "rgba(var(--semi-blue-5), 1)"
  },
  {
    "name": "微信",
    "type": "wxpay",
    "color": "rgba(var(--semi-green-5), 1)"
  }
]
```

5. 点击 **"更新支付设置"** 保存配置

#### 方法二：通过数据库配置

如果通过管理后台无法配置，可以直接在数据库中更新 `options` 表：

```sql
UPDATE options 
SET value = '[{"name":"支付宝","type":"alipay","color":"rgba(var(--semi-blue-5), 1)"},{"name":"微信","type":"wxpay","color":"rgba(var(--semi-green-5), 1)"}]' 
WHERE `key` = 'PayMethods';
```

### 配置参数说明

每个支付方式包含以下字段：

- **name**（必需）: 支付方式显示名称（如："支付宝"、"微信"）
- **type**（必需）: 支付方式类型（必须与易支付支持的支付类型一致）
  - `alipay`: 支付宝支付
  - `wxpay`: 微信支付
  - `stripe`: Stripe（需要单独配置，不通过易支付）
  - `creem`: Creem（需要单独配置，不通过易支付）
  - `custom1`, `custom2` 等: 易支付支持的其他自定义支付类型
- **color**（可选）: 支付方式按钮颜色（CSS 颜色值），例如：
  - 支付宝：`rgba(var(--semi-blue-5), 1)` 或 `#1677FF`
  - 微信：`rgba(var(--semi-green-5), 1)` 或 `#07C160`
- **min_topup**（可选）: 该支付方式的最小充值金额（数字字符串），例如 `"10"` 表示最低充值 10 美元

### 微信支付配置要求

微信支付通过易支付网关接入，需要满足以下要求：

1. **易支付服务商要求**：
   - 易支付服务商必须已开通微信支付通道
   - 易支付服务商需要具备微信支付商户资质
   - 确保易支付服务商的微信支付通道状态正常

2. **系统配置**：
   - 在 `PayMethods` 中配置 `type: "wxpay"`
   - 确保易支付网关配置正确（PayAddress、EpayId、EpayKey）
   - 回调地址必须可公网访问

3. **支付流程**：
   - 用户选择微信支付后，系统调用易支付接口创建订单
   - 易支付返回支付链接或二维码
   - 用户使用微信扫码或跳转完成支付
   - 易支付通过回调通知系统支付结果
   - 系统验证签名并更新订单状态

### 支付宝配置要求

支付宝通过易支付网关接入，需要满足以下要求：

1. **易支付服务商要求**：
   - 易支付服务商必须已开通支付宝支付通道
   - 易支付服务商需要具备支付宝商户资质
   - 确保易支付服务商的支付宝支付通道状态正常

2. **系统配置**：
   - 在 `PayMethods` 中配置 `type: "alipay"`
   - 确保易支付网关配置正确（PayAddress、EpayId、EpayKey）
   - 回调地址必须可公网访问

3. **支付流程**：
   - 用户选择支付宝支付后，系统调用易支付接口创建订单
   - 易支付返回支付链接或二维码
   - 用户使用支付宝扫码或跳转完成支付
   - 易支付通过回调通知系统支付结果
   - 系统验证签名并更新订单状态

### 支持的易支付支付类型

易支付通常支持以下支付类型（具体取决于您的服务商）：

- `alipay` - 支付宝
- `wxpay` - 微信支付
- `qqpay` - QQ钱包
- `bank` - 网银支付
- `usdt` - USDT支付
- 其他自定义支付类型

### 验证配置

#### 方法一：使用系统测试功能（推荐）

1. 登录管理后台
2. 进入 **设置** → **支付设置** → **支付网关设置**
3. 点击 **"测试配置"** 按钮
4. 查看测试结果：
   - ✓ 绿色：配置正常
   - ✗ 红色：配置错误，需要修复
   - ⚠ 黄色：警告信息，建议处理

#### 方法二：手动验证

配置完成后：

1. 刷新前端页面
2. 进入充值页面
3. 应该能看到支付宝和微信支付的选项
4. 点击支付按钮，应该能正常跳转到支付页面
5. 检查后端日志，确认支付请求和回调处理正常

#### 验证清单

- [ ] 易支付网关配置完整（PayAddress、EpayId、EpayKey）
- [ ] 支付方式配置正确（PayMethods JSON 格式正确）
- [ ] 回调地址可公网访问
- [ ] 易支付服务商已开通支付宝和微信支付通道
- [ ] 前端充值页面显示支付选项
- [ ] 支付跳转正常
- [ ] 支付回调处理正常

### 常见问题

#### Q: 配置后看不到支付选项？

A: 请检查：
1. 易支付网关配置是否正确（PayAddress、EpayId、EpayKey）
2. PayMethods JSON 格式是否正确
3. 浏览器控制台是否有错误信息
4. 后端日志是否有相关错误

#### Q: 支付跳转失败？

A: 请检查：
1. 易支付服务商是否已开通对应的支付通道
2. 回调地址是否正确配置
3. 服务器是否能正常访问易支付网关

#### Q: 如何添加更多支付方式？

A: 在 PayMethods JSON 数组中添加新的支付方式配置即可，例如：

```json
[
  {
    "name": "支付宝",
    "type": "alipay",
    "color": "rgba(var(--semi-blue-5), 1)"
  },
  {
    "name": "微信",
    "type": "wxpay",
    "color": "rgba(var(--semi-green-5), 1)"
  },
  {
    "name": "QQ钱包",
    "type": "qqpay",
    "color": "rgba(var(--semi-primary-5), 1)"
  }
]
```

### 默认配置

如果未配置 PayMethods 或配置为空，系统会自动使用以下默认配置：

- 支付宝 (alipay)
- 微信支付 (wxpay)

这样即使没有手动配置，用户也能看到并使用支付宝和微信支付。

### 注意事项

1. **支付类型必须与易支付服务商支持的支付类型一致**
2. **确保易支付服务商已开通对应的支付通道**
3. **回调地址必须可公网访问**
4. **建议在生产环境使用 HTTPS**
5. **如果易支付服务商不支持某个支付类型，即使配置了也无法使用**

## 其他支付方式

### Stripe 配置

Stripe 需要单独配置，不通过易支付网关。配置方法请参考 Stripe 相关文档。

### Creem 配置

Creem 需要单独配置，不通过易支付网关。配置方法请参考 Creem 相关文档。

## 技术说明

### 支付流程详解

#### 完整支付流程

1. **用户发起支付**
   - 用户在前端充值页面选择支付方式（支付宝/微信）
   - 用户输入或选择充值金额
   - 前端计算实际支付金额（考虑折扣和分组倍率）

2. **创建支付订单**
   - 前端调用 `/api/user/pay` 接口，传递：
     - `amount`: 充值金额
     - `payment_method`: 支付方式（`alipay` 或 `wxpay`）
   - 后端验证支付方式是否在配置中
   - 后端创建订单记录（状态：`pending`）
   - 后端调用易支付接口创建支付链接

3. **跳转支付页面**
   - 后端返回支付参数和支付URL
   - 前端通过表单提交或新窗口打开支付页面
   - 用户使用支付宝或微信完成支付

4. **支付回调处理**
   - 易支付平台通过回调地址 `/api/user/epay/notify` 通知系统
   - 后端 `EpayNotify` 函数处理回调：
     - 验证签名确保请求来自易支付
     - 检查订单状态（防止重复处理）
     - 更新订单状态为 `success`
     - 为用户账户增加额度
     - 记录充值日志

5. **订单状态管理**
   - 订单状态：`pending` → `success`
   - 支持管理员手动补单（如果回调失败）
   - 订单记录包含完整的支付信息

#### 支付流程关键点

- **订单号生成**：格式为 `USR{用户ID}NO{随机字符串+时间戳}`，确保唯一性
- **并发控制**：使用订单锁机制防止重复处理
- **签名验证**：所有回调请求都经过签名验证
- **幂等性**：已处理的订单不会重复处理
- **错误处理**：支付失败时订单保持 `pending` 状态，支持补单

### 支付类型映射

- `alipay` → 易支付支付宝通道
- `wxpay` → 易支付微信支付通道
- 其他类型 → 易支付对应的支付通道

### 代码位置

- 支付配置：`setting/operation_setting/payment_setting_old.go`
- 支付控制器：`controller/topup.go`
- 前端组件：`web/src/components/topup/`

